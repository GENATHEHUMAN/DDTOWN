<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.functions" prefix="fn"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN 관리자 - 아티스트 계정 관리</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/emp_common.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/emp_portal_style.css">
    <link rel="stylesheet" href="<%=request.getContextPath()%>/resources/css/pages/group-management.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    <style>
        /* admin_portal.css에 정의된 스타일을 최대한 활용합니다. */
        /* 아티스트명 링크 스타일 */
        .artist-name-link {
            font-weight: 500;
            color: #007bff; /* 기본 링크 색상 */
            text-decoration: none;
        }
        .artist-name-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>

        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
			<c:set var="title" value="새 그룹 등록"/>
			<c:if test="${status eq 'U' }">
				<c:set var="title" value="그룹 수정"/>
			</c:if>
			<c:set var="text" value="등록"/>
			<c:if test="${status eq 'U' }">
				<c:set var="text" value="수정"/>
			</c:if>
            <main class="emp-content">
                <section class="ea-section">
                    <div class="ea-section-header">
                        <h2>${title }</h2>
                    </div>
                    <form class="ea-form" id="newGroupForm" method="post" action="${pageContext.request.contextPath}/admin/community/group/regist" encType="multipart/form-data">
                    	<sec:csrfInput/>
                    	<input type="hidden" name="artGroupNo" value="${artistGroupVO.artGroupNo}">
                    	<input type="hidden" name="artGroupProfileImg" value="${artistGroupVO.artGroupProfileImg}">
                        <div class="form-group">
                            <label for="groupName">그룹명</label>
                            <input type="text" id="artGroupNm" name="artGroupNm" value="${artistGroupVO.artGroupNm }" required>
                        </div>
                        <div class="form-group">
                            <label for="groupDebutDate">데뷔일</label>
                            <input type="text" id="artGroupDebutdate" name="artGroupDebutdate" value="${artistGroupVO.artGroupDebutdate }">
                        </div>
                        <div class="form-group" id="autocomplete">
                            <label for="groupManager">담당자 등록</label>
                            <select class="form-control h-20" name="empUsername">
                            	<c:forEach items="${empList }" var="emp">
                            		<option value="${emp.username }" <c:if test="${artistGroupVO.empUsername eq emp.username}">selected</c:if>>${emp.peoName }</option>
                            	</c:forEach>
                            </select>
                        </div>
                        <div class="form-group">
		                    <fieldset>
		                        <legend style="font-weight: bold; padding: 0; margin-bottom: 5px; border: 0; display: block; width:auto;">활동유형:</legend>
		                        <div class="radio-options-wrapper" style="display: block; margin-left: 0px; margin-top: 5px;">
		                            <label class="radio-label" for="artGroupTypeGroup" style="margin-right: 15px; cursor:pointer; font-weight:normal;">
		                                <input type="radio" name="artGroupTypeCode" value="AGTC001" id="artGroupTypeGroup" <c:if test="${artistGroupVO.artGroupTypeCode eq 'AGTC001'}">checked</c:if>>그룹
		                            </label>
		                            <label class="radio-label" for="artGroupTypeSolo" style="cursor:pointer; font-weight:normal;">
		                                <input type="radio" name="artGroupTypeCode" value="AGTC002" id="artGroupTypeSolo" <c:if test="${artistGroupVO.artGroupTypeCode eq 'AGTC002'}">checked</c:if>>솔로
		                            </label>
		                        </div>
		                    </fieldset>
		                </div>
                        <div class="form-group">
                           	<fieldset>
		                        <legend class="form-label" style="font-weight: bold; padding: 0; margin-bottom: 10px; border: 0; display: block; width: auto;">그룹멤버</legend>
		                        <div id="selectedArtistContainer" class="members-container" style="margin-bottom: 10px; min-height: 40px; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
	                            	<c:forEach items="${artistGroupVO.artistList }" var="artist">
	                            		<p class="member-tag" >
											${artist.artNm }
											<span class="removeAritistBtn" data-art-no="${artist.artNo}">
												<i class="bi bi-x"></i>
											</span>
										</p>
	                            	</c:forEach>
		                        </div>
		                        <div class="input-group-for-member-add" style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
		                            <select id="artistSelect" class="form-control" style="flex-grow: 1;">
		                                <option value="">-- 아티스트 선택 --</option>
		                                <c:forEach items="${artistList}" var="artist">
		                                    <option value="${artist.artNo}_${artist.artNm}">${artist.artNm }</option>
		                                </c:forEach>
		                            </select>
		                            <button type="button" id="addArtistBtn" class="action-button" style="white-space: nowrap;">멤버 추가</button>
		                        </div>
		                    </fieldset>
                        </div>
                        
                        <div class="form-group">
                           	<fieldset>
		                        <legend class="form-label" style="font-weight: bold; padding: 0; margin-bottom: 10px; border: 0; display: block; width: auto;">앨범등록</legend>
		                        <div id="selectedAlbumContainer" class="members-container" style="margin-bottom: 10px; min-height: 40px; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
	                            	<c:forEach items="${artistGroupVO.albumList}" var="album">
	                            		<p class="member-tag" >
											${album.albumNm }
											<span class="removeAlbumBtn" data-album-nm="${album.albumNm}" data-album-no="${album.albumNo }">
												<i class="bi bi-x"></i>
											</span>
										</p>
	                            	</c:forEach>
		                        </div>
		                        <div class="input-group-for-member-add" style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
		                            <select id="albumSelect" class="form-control" style="flex-grow: 1;">
		                                <option value="">-- 앨범 선택 --</option>
		                                <c:forEach items="${albumList}" var="album">
		                                    <option value="${album.albumNo}_${album.albumNm}">${album.albumNm }</option>
		                                </c:forEach>
		                            </select>
		                            <button type="button" id="addAlbumBtn" class="action-button" style="white-space: nowrap;">앨범 추가</button>
		                        </div>
		                    </fieldset>
                        </div>
                        <div class="form-group">
                            <label for="groupProfileImage">프로필 이미지</label>
                            <input type="file" id="groupProfileImage" name="profileImage" accept="image/*" class="ea-form-control" style="width:auto; height:auto; padding: 5px;">
                            <img id="groupProfileImagePreview" src="" alt="">
                        </div>
                        
                        <div class="form-group">
                            <label for="artGroupContent">아티스트 소개</label>
                            <textarea id="artGroupContent" name="artGroupContent" placeholder="아티스트그룹에 대한 간략한 소개를 입력하세요." class="ea-form-control">${artistGroupVO.artGroupContent }</textarea>
                        </div>
                        
                        <div class="ea-form-actions">
                        	<c:set var="url" value="/admin/community/group/list"/>
                        	<c:if test="${status eq 'U' }">
	                        	<c:set var="url" value="/admin/community/group/detail?artGroupNo=${artistGroupVO.artGroupNo }"/>
                        	</c:if>
                            <a href="${url }" class="ea-btn outline">취소</a>
                            <button type="button" class="ea-btn primary" id="registerGroupBtn">${text }</button>
                        </div>
                    </form>
                    <!-- 그룹 멤버 추가 모달 -->
                    <div id="artistModal" class="modal">
                        <div class="modal-content">
                            <h3>아티스트 선택</h3>
                            <div class="artist-list-modal" id="artistListInModal"></div>
                            <button type="button" class="ea-btn" id="closeArtistModalBtn">닫기</button>
                        </div>
                    </div>
                    <!-- 앨범 등록 모달 -->
                    <div id="albumModal" class="modal">
                        <div class="modal-content">
                            <h3>앨범 등록</h3>
                            <label>앨범명 <input type="text" id="albumName"></label><br>
                            <label>발매일 <input type="date" id="albumReleaseDate"></label><br>
                            <label>커버 이미지 <input type="file" id="albumCover"></label><br>
                            <button type="button" class="ea-btn" id="saveAlbumBtn">등록</button>
                            <button type="button" class="ea-btn" id="closeAlbumModalBtn">닫기</button>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <footer class="emp-footer">
            <p>&copy; 2025 DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>
</body>
<%@ include file="../../modules/footerPart.jsp" %>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
	const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
	navItemsWithSubmenu.forEach(item => {
		const arrow = item.querySelector('.submenu-arrow');
		item.addEventListener('click', function(event) {
			if (this.getAttribute('href') === '#') {
			    event.preventDefault();
			}
			const parentLi = this.parentElement;
			const submenu = this.nextElementSibling;
		
			if (submenu && submenu.classList.contains('emp-submenu')) {
				const parentUl = parentLi.parentElement;
				if (parentUl) {
					Array.from(parentUl.children).forEach(siblingLi => {
						if (siblingLi !== parentLi) {
							const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
							if (siblingSubmenuControl) {
								const siblingSubmenu = siblingSubmenuControl.nextElementSibling;
								siblingSubmenuControl.classList.remove('open');
								if (siblingSubmenu && siblingSubmenu.classList.contains('emp-submenu')) {
								    siblingSubmenu.style.display = 'none';
								}
								const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
								if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
							}
						}
					});
				}
			}
		
			this.classList.toggle('open');
			if (submenu && submenu.classList.contains('emp-submenu')) {
				submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
				if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
			}
		});
	});
	
	let groupProfileImage = document.getElementById("groupProfileImage");
	let groupProfileImagePreview = document.getElementById("groupProfileImagePreview");
	
	groupProfileImage.addEventListener("change",function(){
		const file = this.files[0];
		if(!file.type.startsWith("image/")){
			sweetAlert("error","사진 파일만 입력해주세요");
			this.value = null;
			groupProfileImagePreview.src = "";
			return false;
		}
		const maxSize = 2 * 1024 * 1024;
		if(file.size > maxSize){
			sweetAlert("error", "2MB 미만의 사진만 등록해주세요");
			this.value = "";
			groupProfileImagePreview.src = "";
			return false;
		}
		
		const reader = new FileReader();
		reader.onload = function(e){
			console.dir(e)
			groupProfileImagePreview.src = e.target.result
		}
		reader.readAsDataURL(file);
		
	});
});
$(function(){
	// 아티스트 추가 등록
	let addArtistBtn = $("#addArtistBtn");
	// 아티스트 기존 멤버 제거
	let removeAritistBtn = $(".removeAritistBtn");
	// 앨범 추가 등록
	let addAlbumBtn = $("#addAlbumBtn");
	// 기존 앨범 삭제
	let removeAlbumBtn = $(".removeAlbumBtn");
	// 추가 할 멤버
	let artistSelect = $("#artistSelect");
	// 추가 할 앨범
	let albumSelect = $("#albumSelect");
	
	let selectedArtistContainer = $("#selectedArtistContainer");
	let selectedAlbumContainer = $("#selectedAlbumContainer");
	
	
	// 아티스트 추가 버튼
	addArtistBtn.on("click",function(){
		let artInfo = artistSelect.val().split("_");
		let artNo = artInfo[0];
		let artNm = artInfo[1];
		let selectedInput = selectedArtistContainer.find(`p.member-tag > span[data-art-no=\${artNo}]`).length;
		if(selectedInput > 0){
			sweetAlert("error","이미 추가된 멤버입니다.");
			return false;
		}
		const addInput = $("#newGroupForm").find(`input[type="hidden"][name="removeArtists"][value="\${artNo}"]`);
		if(addInput.length > 0){
			addInput.remove();			
		}
		let html = ``;
		html += `
			<p class="member-tag" >
				\${artNm }
				<span class="removeAritistBtn" data-art-no="\${artNo}">
					<i class="bi bi-x"></i>
				</span>
			</p>
		`;
		selectedArtistContainer.append(html)
		let hiddenInput = `
			<input type="hidden" name="addArtists" value="\${artNo}">
		`;
		$("#newGroupForm").append(hiddenInput);
	})
	
	// 아티스트 제거 버튼
	selectedArtistContainer.on("click",".removeAritistBtn",function(){
		let artNo = $(this).data("artNo");
		let div = $(this).parent("p.member-tag");
		div.remove();
		let hiddenInput = `
			<input type="hidden" name="removeArtists" value="\${artNo}">
		`;
		const addInput = $("#newGroupForm").find(`input[type="hidden"][name="removeArtists"][value="\${artNo}"]`);
		if(addInput.length > 0){
			addInput.remove();
		}
		$("#newGroupForm").append(hiddenInput);
	});
	
	// 앨범 추가 버튼
	addAlbumBtn.on("click",function(){
		let artInfo = albumSelect.val().split("_");
		let albumNo = artInfo[0];
		let albumNm = artInfo[1];
		const existingAddInput = $("#newGroupForm").find(`input[type="hidden"][name="addAlbums"][value="${albumNo}"]`);
	    if (existingAddInput.length > 0) {
	        sweetAlert("error", "이미 추가된 앨범입니다."); // 메시지 수정
	        return false;
	    }
		const addInput = $("#newGroupForm").find(`input[type="hidden"][name="removeAlbums"][value="\${albumNo}"]`);
		addInput.remove();
		let html = ``;
		html += `
			<p class="member-tag" >
				\${albumNm }
				<span class="removeAlbumBtn" data-album-nm="\${albumNm}" data-album-no="\${albumNo}">
					<i class="bi bi-x"></i>
				</span>
			</p>
		`;
		selectedAlbumContainer.append(html)
		let hiddenInput = `
			<input type="hidden" name="addAlbums" value="\${albumNo}">
		`;
		$("#newGroupForm").append(hiddenInput);
		albumSelect.find(`option[value="\${albumNo}_\${albumNm}"]`).remove();
	})
	
	// 앨범 제거 버튼
	selectedAlbumContainer.on("click",".removeAlbumBtn",function(){
		console.log("asdf");
		let albumNo = $(this).data("albumNo");
		let albumNm = $(this).data("albumNm");
		let div = $(this).parent("p.member-tag");
		div.remove();
		const albumOpt = new Option(albumNm,albumNo+"_"+albumNm);
		albumSelect.append(albumOpt);
		let hiddenInput = `
			<input type="hidden" name="removeAlbums" value="\${albumNo}">
		`;
		const addInput = $("#newGroupForm").find(`input[type="hidden"][name="addAlbums"][value="\${albumNo}"]`);
		if(addInput.length > 0){
			addInput.remove();
		}
		$("#newGroupForm").append(hiddenInput);
	});
	
	
	
	// 등록 버튼
	const registerGroupBtn = $("#registerGroupBtn");
	registerGroupBtn.on("click",function(){
		if($(this).text() == '수정'){
			$("#newGroupForm").attr("action", "${pageContext.request.contextPath}/admin/community/group/update")
		}
		$("#newGroupForm").submit();
	})
})
</script>
</html>