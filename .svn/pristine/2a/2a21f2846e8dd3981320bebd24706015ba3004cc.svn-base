<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APT 상세/수정 - DDTOWN 관리자</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 상세보기 스타일 */
        #aptDetailView {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 32px 28px 24px 28px;
            max-width: 100%;
            margin: 0 32px ;
        }
        #aptDetailView .form-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 18px;
        }
        #aptDetailView label {
            min-width: 120px;
            font-weight: 600;
            color: #2d3a4b;
            margin-right: 18px;
            font-size: 1.05em;
            padding-top: 2px;
        }
        #aptDetailView div[id^="viewApt"] {
            flex: 1;
            color: #222;
            font-size: 1.04em;
            word-break: break-all;
        }
        #aptDetailView img#viewAptCoverImage {
            margin-top: 2px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            max-width: 350px;
            max-height: 160px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }
        #aptDetailView .ea-form-actions {
            margin-top: 32px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        /* 수정폼 스타일 개선 */
        #aptForm.emp-form {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 32px 28px 24px 28px;
            max-width: 100%;
            margin: 0  32px;
        }
        #aptForm .form-group {
            margin-bottom: 18px;
        }
        #aptForm label {
            font-weight: 600;
            color: #2d3a4b;
            margin-bottom: 6px;
            display: block;
        }
        #aptForm input[type="text"],
        #aptForm select,
        #aptForm textarea {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 1em;
            background: #f8fafd;
            margin-top: 2px;
        }
        #aptForm textarea {
            min-height: 90px;
        }
        #aptForm .help-text {
            color: #7b8794;
            font-size: 0.97em;
            margin-top: 2px;
        }
        #aptForm .ea-form-actions {
            margin-top: 32px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        #aptForm #aptCoverImagePreview {
            margin-top: 4px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            max-width: 350px;
            max-height: 160px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }
        .emp-form .form-group textarea#aptDescription { min-height: 100px; }
        .emp-form .form-group #aptCoverImagePreview {
            width: 100%; max-width: 400px; height: auto; max-height: 200px;
            border: 1px solid #ddd; border-radius: 8px; object-fit: cover; margin-top: 10px; display: block;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>
        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>
            <main class="emp-content">
                <section id="aptFormSection" class="ea-section active-section">
                    <div class="ea-section-header">
                        <h2 id="aptFormTitle">APT 상세/수정</h2>
                    </div>
                    <div id="aptDetailView" style="display:none;">
                        <div class="form-group"><label>APT ID</label><div id="viewAptSystemId"></div></div>
                        <div class="form-group"><label>APT 이름</label><div id="viewAptDisplayName"></div></div>
                        <div class="form-group"><label>연결 아티스트</label><div id="viewLinkedArtist"></div></div>
                        <div class="form-group"><label>APT 소개</label><div id="viewAptDescription"></div></div>
                        <div class="form-group"><label>APT 상태</label><div id="viewAptStatus"></div></div>
                        <div class="form-group"><label>커버 이미지</label><img id="viewAptCoverImage" style="max-width:400px;max-height:200px;border:1px solid #ddd;border-radius:8px;" src="" alt="APT 커버 이미지"></div>
                        <div class="ea-form-actions">
                            <button type="button" class="ea-btn primary" id="editAptBtn">수정</button>
                            <button type="button" class="ea-btn danger" id="deleteAptBtn">삭제</button>
                            <a href="/admin/community/apt/list" class="ea-btn outline">취소</a>
                        </div>
                    </div>
                    <form class="emp-form" id="aptForm" style="display:none;">
                        <input type="hidden" id="aptDbId" name="aptDbId">
                        <div class="form-group">
                            <label for="aptSystemId">APT ID (시스템 내부용, 영문/숫자/언더스코어)</label>
                            <input type="text" id="aptSystemId" name="aptSystemId" placeholder="예: APT_ARTIST_A, ARTIST_B_COMMUNITY" required>
                            <p class="help-text">시스템에서 이 APT를 고유하게 식별하는 ID입니다. URL 등에 사용될 수 있습니다.</p>
                        </div>
                        <div class="form-group">
                            <label for="aptDisplayName">APT 표시 이름 (커뮤니티 이름)</label>
                            <input type="text" id="aptDisplayName" name="aptDisplayName" placeholder="예: Artist A's APT, Group B 공식 커뮤니티" required>
                        </div>
                        <div class="form-group">
                            <label for="linkedArtistId">연결될 아티스트 선택</label>
                            <select id="linkedArtistId" name="linkedArtistId" required>
                                <option value="">-- 아티스트 선택 --</option>
                                <option value="ARTIST_A_001">Artist A (Group Alpha)</option>
                                <option value="ARTIST_B_SOLO">Artist B (솔로)</option>
                                <option value="GROUP_GAMMA">Group Gamma (그룹 계정)</option>
                            </select>
                            <p class="help-text">이 APT를 사용할 아티스트(또는 그룹)를 선택합니다.</p>
                        </div>
                        <div class="form-group">
                            <label for="aptDescription">APT 소개 (선택 사항)</label>
                            <textarea id="aptDescription" name="description" placeholder="이 APT(커뮤니티)에 대한 간략한 소개를 입력하세요."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="aptCoverImage">APT 커버 이미지 (선택 사항)</label>
                            <input type="file" id="aptCoverImage" name="coverImage" accept="image/*">
                            <img id="aptCoverImagePreview" src="https://via.placeholder.com/400x150/e9ecef/adb5bd?text=커버+이미지+선택" alt="커버 이미지 미리보기">
                            <p class="help-text" id="currentCoverImageName">현재 커버 이미지: 없음</p>
                        </div>
                        <div class="form-group">
                            <label for="aptStatus">APT 상태</label>
                            <select id="aptStatus" name="status">
                                <option value="active">활성 (공개)</option>
                                <option value="inactive">비활성 (준비중 또는 비공개)</option>
                                <option value="archived">보관 (더 이상 사용 안함)</option>
                            </select>
                        </div>
                        <div class="ea-form-actions">
                            <a href="/admin/community/apt/list" class="ea-btn outline">취소</a>
                            <button type="submit" class="ea-btn primary" id="saveAptBtn">저장</button>
                        </div>
                    </form>
                </section>
            </main>
        </div>
        <footer class="emp-footer">
            <p>&copy; 2025 DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>
    <script>
        // 로그아웃 기능
        const logoutButton = document.querySelector('.emp-logout-btn');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('로그아웃 하시겠습니까?')) {
                    alert('로그아웃 되었습니다.');
                }
            });
        }

        // 사이드바 메뉴 기능
        document.addEventListener('DOMContentLoaded', function() {
            const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
            navItemsWithSubmenu.forEach(item => {
                const arrow = item.querySelector('.submenu-arrow');
                item.addEventListener('click', function(event) {
                    if (this.classList.contains('has-submenu')) {
                        event.preventDefault();
                        const currentlyOpen = this.classList.contains('open');
                        document.querySelectorAll('.emp-sidebar > .emp-nav > ul > li > .has-submenu.open').forEach(openItem => {
                            if (openItem !== this) {
                                openItem.classList.remove('open');
                                const submenu = openItem.nextElementSibling;
                                if (submenu && submenu.classList.contains('emp-submenu')) {
                                    submenu.style.display = 'none';
                                }
                                const openArrow = openItem.querySelector('.submenu-arrow');
                                if(openArrow) openArrow.style.transform = 'rotate(0deg)';
                            }
                        });
                        this.classList.toggle('open');
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('emp-submenu')) {
                            submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
                            if(arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
                        }
                    }
                });
            });

         // 폼 초기화 및 유효성 검사, 커버 이미지 프리뷰 등
           const urlParams = new URLSearchParams(window.location.search);
           const aptSystemIdParam = urlParams.get('id');
           const mode = urlParams.get('mode');
           const formTitleEl = document.getElementById('aptFormTitle');
           const saveBtnEl = document.getElementById('saveAptBtn');
           const aptSystemIdEl = document.getElementById('aptSystemId');
           const aptDisplayNameEl = document.getElementById('aptDisplayName');
           const linkedArtistIdEl = document.getElementById('linkedArtistId');
           const aptDescriptionEl = document.getElementById('aptDescription');
           const aptCoverImageEl = document.getElementById('aptCoverImage');
           const aptCoverImagePreviewEl = document.getElementById('aptCoverImagePreview');
           const currentCoverImageNameEl = document.getElementById('currentCoverImageName');
           const aptStatusEl = document.getElementById('aptStatus');
           if (aptCoverImageEl && aptCoverImagePreviewEl) {
               aptCoverImageEl.addEventListener('change', function(event) {
                   const file = event.target.files[0];
                   if (file) {
                       const reader = new FileReader();
                       reader.onload = function(e) { aptCoverImagePreviewEl.src = e.target.result; }
                       reader.readAsDataURL(file);
                       if(currentCoverImageNameEl) currentCoverImageNameEl.textContent = `새 커버 이미지: ${file.name}`;
                   } else {
                       aptCoverImagePreviewEl.src = "https://via.placeholder.com/400x150/e9ecef/adb5bd?text=커버+이미지+선택";
                       if(currentCoverImageNameEl) currentCoverImageNameEl.textContent = `현재 커버 이미지: 없음`;
                   }
               });
           }
           // 상세/수정 분기
           const aptDetailView = document.getElementById('aptDetailView');
           const aptForm = document.getElementById('aptForm');
           if (mode === 'edit') {
               aptDetailView.style.display = 'none';
               aptForm.style.display = '';
               // 실제로는 서버에서 aptSystemIdParam 으로 APT 데이터를 가져와 폼에 채웁니다.
               const sampleEditAptData = {
                   systemId: aptSystemIdParam,
                   displayName: "Artist A's APT (수정)",
                   linkedArtist: "ARTIST_A_001",
                   description: "Artist A의 APT 커뮤니티입니다. 수정된 소개글입니다.",
                   status: "active",
                   coverImageUrl: "https://via.placeholder.com/400x150/8A2BE2/FFFFFF?text=Artist+A+APT+Cover"
               };
               if(aptSystemIdEl) aptSystemIdEl.value = sampleEditAptData.systemId;
               if(aptDisplayNameEl) aptDisplayNameEl.value = sampleEditAptData.displayName;
               if(linkedArtistIdEl) linkedArtistIdEl.value = sampleEditAptData.linkedArtist;
               if(aptDescriptionEl) aptDescriptionEl.value = sampleEditAptData.description;
               if(aptStatusEl) aptStatusEl.value = sampleEditAptData.status;
               if(aptCoverImagePreviewEl && sampleEditAptData.coverImageUrl) {
                   aptCoverImagePreviewEl.src = sampleEditAptData.coverImageUrl;
                   if(currentCoverImageNameEl) currentCoverImageNameEl.textContent = `현재 커버 이미지: ${sampleEditAptData.coverImageUrl.split('/').pop()}`;
               }
           } else {
               aptDetailView.style.display = '';
               aptForm.style.display = 'none';
               // 샘플 데이터 (실제는 서버에서 받아옴)
               const sample = {
                   systemId: aptSystemIdParam || 'APT_ARTIST_A',
                   displayName: "Artist A's APT",
                   linkedArtist: "Artist A (Group Alpha)",
                   description: "Artist A의 APT 커뮤니티입니다.",
                   status: "활성 (공개)",
                   coverImageUrl: "https://via.placeholder.com/400x150/8A2BE2/FFFFFF?text=Artist+A+APT+Cover"
               };
               document.getElementById('viewAptSystemId').textContent = sample.systemId;
               document.getElementById('viewAptDisplayName').textContent = sample.displayName;
               document.getElementById('viewLinkedArtist').textContent = sample.linkedArtist;
               document.getElementById('viewAptDescription').textContent = sample.description;
               document.getElementById('viewAptStatus').textContent = sample.status;
               document.getElementById('viewAptCoverImage').src = sample.coverImageUrl;
               // 버튼 이벤트
               document.getElementById('editAptBtn').onclick = function() {
                   location.href = `/admin/community/apt/detail?id=${sample.systemId}&mode=edit`;
               };
               document.getElementById('deleteAptBtn').onclick = function() {
                   if(confirm('정말 삭제하시겠습니까?')) {
                       alert('APT가 삭제되었습니다. (서버 연동 필요)');
                       location.href = '/admin/community/apt/list';
                   }
               };
           }
           // 폼 제출 처리 (유효성 검사)
           if (aptForm) {
               aptForm.addEventListener('submit', function(event) {
                   event.preventDefault();
                   if (!aptSystemIdEl.value.trim()) {
                       alert('APT ID를 입력해주세요.');
                       aptSystemIdEl.focus();
                       return;
                   }
                   if (!aptDisplayNameEl.value.trim()) {
                       alert('APT 표시 이름을 입력해주세요.');
                       aptDisplayNameEl.focus();
                       return;
                   }
                   if (!linkedArtistIdEl.value) {
                       alert('연결될 아티스트를 선택해주세요.');
                       linkedArtistIdEl.focus();
                       return;
                   }
                   alert((mode === 'edit' ? 'APT 정보 수정' : '새 APT 생성') + ' 완료! (서버 연동 필요)');
                   window.location.href = '/admin/community/apt/list';
               });
           }
       });
    </script>
</body>
</html> 