<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/pages/emp_common.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="${pageContext.request.contextPath}/resources/ckeditorInquiry/ckeditor.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" >
<style type="text/css">
.calendar-header-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.calendar-header-bar .calendar-title { font-size: 1.5em; font-weight: 700; color: #234aad; }
.calendar-header-bar .calendar-add-btn { background: #1976d2; color: #fff; border: none; border-radius: 5px; padding: 8px 22px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; }
.calendar-header-bar .calendar-add-btn:hover { background: #1451a3; }
.calendar-info-box { background: #e3f0ff; color: #234aad; border-radius: 6px; padding: 12px 18px; margin-bottom: 18px; font-size: 1em; display: flex; align-items: center; gap: 8px; }

#tooltip {
  position: absolute;
  background-color: #333;
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  white-space: nowrap;
  pointer-events: none; /* 중요: 툴팁이 마우스 이벤트를 방해하지 않도록 */
}

#tooltip .tooltip-text {
  display: block;
  margin-bottom: 3px;
}
#tooltip .tooltip-text:last-child {
  margin-bottom: 0;
}

</style>
</head>

<body>
<main class="emp-content" style="position:relative; min-height:600px;">
	<div class="calendar-header-bar">
        <div class="calendar-title">아티스트 일정 관리</div>
        <button class="calendar-add-btn" id="addScheduleBtn"><i class="fas fa-calendar-plus"></i> 새 일정 등록</button>
    </div>
    <div id="calendar"></div>
</main>




<div class="tooltip-container" id="tooltip" style="visibility:hidden">
	<span class="tooltip-text" id="toolContent"></span>
	<span class="tooltip-text" id="toolPlace"></span>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">이벤트 상세 정보</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="eventDetails"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="editEvent">수정</button>
                    <button type="button" class="btn btn-danger" id="deleteEvent">삭제</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">

$(function(){
	console.log("123");
	fullCalendar();
	
	
});


function fullCalendar(){
	var calendarEl = document.getElementById('calendar');
	var calendar = new FullCalendar.Calendar(calendarEl, {
		initialView : 'dayGridMonth',
		editable : true,
		events : "/emp/schedule/list",
		eventMouseEnter : function (info){
			// console.log("prop 찾기 : ",info.event.extendedProps)
			let {content, place } = info.event.extendedProps;
			// console.log(content,place);
			$("#toolContent").html(content);
			$("#toolPlace").html(place);
			const eventElementRect = info.el.getBoundingClientRect(); // 마우스 오버된 이벤트 요소의 화면상 위치/크기
            // const tooltipCurrentRect = tooltip.getBoundingClientRect(); // 현재 툴팁 크기 (내용 설정 후 정확해짐)

            // 페이지 스크롤 값 고려 (getBoundingClientRect는 뷰포트 기준)
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

            // 툴팁을 이벤트 요소의 바로 위에 위치시키기
            // tooltip.offsetHeight는 툴팁 내용이 채워진 후의 실제 높이
            let topPosition = eventElementRect.top + scrollTop - tooltip.offsetHeight - 5; // 5px 간격
            let leftPosition = eventElementRect.left + scrollLeft + (eventElementRect.width / 2) - (tooltip.offsetWidth / 2); // 가로 중앙 정렬

            // 화면 가장자리 넘어가지 않도록 보정 (간단한 버전)
            if (leftPosition < 0) leftPosition = scrollLeft + 5;
            if (leftPosition + tooltip.offsetWidth > window.innerWidth + scrollLeft) {
                leftPosition = window.innerWidth + scrollLeft - tooltip.offsetWidth - 5;
            }
            if (topPosition < scrollTop) { // 화면 상단을 벗어날 경우
                topPosition = eventElementRect.bottom + scrollTop + 5; // 이벤트 요소 아래로 변경
            }

            tooltip.style.top = topPosition + 'px';
            tooltip.style.left = leftPosition + 'px';

            // 3. 툴팁 보이기
            tooltip.style.visibility = 'visible';
            tooltip.style.opacity = '1';
		},
		eventMouseLeave: function(info) {
            // 툴팁 숨기기
            tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        },
        eventDragStart: function() {
        	tooltip.style.visibility = 'hidden';
            tooltip.style.opacity = '0';
        },
        eventDrop : function(e){
        	let endDate = e.event.end;
        	
        	let id = e.event.id;
        	let date = e.event.start.toISOString();
        	let start = dateFormat(date);
        	let end;
        	if(endDate == null){
        		end = start;
        	}else{
        		end = endDate.toISOString();
        	}
        	
        	let data = new FormData();
        	data.append("start",start);
        	data.append("end", end);
        	
        	$.ajax({
        		url : "/emp/schedule/dateUpdate/" + id,
        		type : "post",
        		data : data,
        		processData : false,
        		contentType : false,
        		success : function(res){
        			console.log(res);
        		},
        		error : function(error, status, thrown){
        			console.log(error.status);
        		},
        		beforeSend : function(xhr) {
			        xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
			    }
        	}); 
        },
        eventClick: function(event){
        	console.log(event)
        	event.jsEvent.cancelBubble = true;
        	event.jsEvent.preventDefault();
        	
        	const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        	eventModal.show();
        	
        }
		
		
		
	});
	calendar.render();
}

function dateFormat(updateDate){
	if (!updateDate) return "";

	let date = updateDate.split('-');
	
	let year = date[0];
	let month = date[1];
	let dayTime = date[2].split('T');
	let day = parseInt(dayTime[0]) + 1;
	console.log(day)
	
	let point = dayTime[1].indexOf('.');
	let time = dayTime[1].substring(0, point);
	console.log(time);
	
	
    return year + "-" + month + "-" + day + "T" + time;
}

</script>
</html>