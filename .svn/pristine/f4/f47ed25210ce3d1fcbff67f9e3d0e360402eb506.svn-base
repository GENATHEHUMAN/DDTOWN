<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>아티스트 관리</title>
<style>
    /* CSS는 이전과 거의 동일 */
    body {
        font-family: sans-serif;
    }
    main.emp-content {
        width: 90%;
        margin: 20px auto;
    }
    .search-and-controls { /* 검색창과 추가 버튼 등을 위한 컨테이너 */
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .artist-search-form { /* form 태그에 적용할 스타일 */
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .artist-search-form select.form-control,
    .artist-search-form input[type="text"].form-control {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .artist-search-form select.form-control {
        width: auto; /* 자동으로 너비 조절 */
    }
    .artist-search-form input[type="text"].form-control {
        flex-grow: 1; /* 가능한 공간 채우기 */
    }
    .artist-search-form button { /* 검색 버튼 */
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .artist-search-form button:hover {
        background-color: #0056b3;
    }
    table.artist-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        table-layout: fixed;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        vertical-align: middle;
        word-wrap: break-word;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    th.col-profile-path, td.col-profile-path {
        width: 30%;
    }
    th.col-actions, td.col-actions {
        width: 15%; /* 수정 버튼 공간 확보 */
    }

    .action-button {
        padding: 6px 12px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .action-button:hover {
        background-color: #218838;
    }
    .modal-actions {
        text-align: right;
        margin-top: 20px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 60%;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0
            rgba(0, 0, 0, 0.19);
        border-radius: 5px;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover, .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .modal-content hr {
        margin-top: 5px;
        margin-bottom: 15px;
    }

    .modal-content div.form-group {
        margin-bottom: 15px;
    }
    .modal-content input[type="text"],
    .modal-content input[type="file"], 
    .modal-content textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        margin-top: 4px;
        box-sizing: border-box;
    }
    .modal-content input[readonly] { 
        background-color: #e9ecef;
    }
    .modal-content textarea {
        resize: vertical;
    }
    .form-group label {
        display: block;
        margin-bottom: 3px;
        font-weight: bold;
    }
    small {
        font-size: 0.85em;
        color: #6c757d;
    }
    /* 페이지네이션 스타일 (PaginationInfoVO에서 생성하는 ul.pagination 가정) */
    .pagination {
        justify-content: center;
        padding-left: 0;
        list-style: none;
        border-radius: .25rem;
    }
    .pagination > li > a, .pagination > li > span {
        position: relative;
        float: left;
        padding: .5rem .75rem;
        margin-left: -1px;
        line-height: 1.25;
        color: #007bff;
        background-color: #fff;
        border: 1px solid #dee2e6;
    }
    .pagination > li.active > span, .pagination > li.active > a {
        z-index: 1;
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }
    .pagination > li:first-child > a, .pagination > li:first-child > span {
        margin-left: 0;
        border-top-left-radius: .25rem;
        border-bottom-left-radius: .25rem;
    }
    .pagination > li:last-child > a, .pagination > li:last-child > span {
        border-top-right-radius: .25rem;
        border-bottom-right-radius: .25rem;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<%@ include file="../../modules/headerPart.jsp" %>
<%@ include file="../../admin/modules/aside.jsp" %>
<%@ include file="../../admin/modules/header.jsp" %>
</head>
<body>
    <main class="emp-content">
        <h2>아티스트 개별 관리</h2>

        <div class="search-and-controls">
            <form method="GET" action="${pageContext.request.contextPath}/emp/artist/management" class="artist-search-form">
                <select name="searchType" class="form-control">
                    <option value="name" ${pagingVO.searchType == 'name' ? 'selected' : ''}>이름</option>
                    <option value="content" ${pagingVO.searchType == 'content' ? 'selected' : ''}>소개글</option>
                </select>
                <input type="text" name="searchWord" class="form-control" value="${pagingVO.searchWord}" placeholder="검색어를 입력하세요...">
                <input type="hidden" name="page" value="1"> 
                <button type="submit" id="artist-search-btn"><i class="fas fa-search"></i> 검색</button>
            </form>
        </div>

        <c:if test="${not empty pagingVO.dataList}">
            <table class="artist-table">
                <thead>
                    <tr>
                        <th>번호</th>
                        <th class="col-profile-path">프로필 이미지 경로</th>
                        <th>아티스트명</th>
                        <th>수정일</th>
                        <th class="col-actions">관리</th>
                    </tr>
                </thead>
                <tbody id="artist-table-body">
                    <c:forEach items="${pagingVO.dataList}" var="artist">
                        <tr>
                            <td>${artist.artNo }</td>
                            <td class="col-profile-path">
                                <c:out value="${artist.artProfileImg }"/>
                            </td>
                            <td><c:out value="${artist.artNm }"/></td>
                            <td>
                                <fmt:formatDate value="${artist.artModDate }" pattern="yyyy-MM-dd HH:mm:ss" var="formattedModDate"/>
                                <c:out value="${formattedModDate}"/>
                            </td>
                            <td class="col-actions">
                                <button class="action-button edit-artist-btn"
                                        data-artist-no="${artist.artNo}"
                                        data-artist-nm="<c:out value='${artist.artNm}'/>"
                                        data-artist-mod-date="${formattedModDate}"
                                        data-artist-content="<c:out value='${artist.artContent}' escapeXml='true'/>"
                                        data-artist-profileimg="<c:out value='${artist.artProfileImg}'/>">수정</button>
                            </td>
                        </tr>
                    </c:forEach>
                </tbody>
            </table>
        </c:if>
        <c:if test="${empty pagingVO.dataList}">
            <p style="text-align: center;">
                <c:choose>
                    <c:when test="${not empty pagingVO.searchWord}">
                        '${pagingVO.searchWord}'에 대한 검색 결과가 없습니다.
                    </c:when>
                    <c:otherwise>
                        등록된 아티스트가 없습니다.
                    </c:otherwise>
                </c:choose>
            </p>
        </c:if>
        
        <div id="pagingArea" class="d-flex justify-content-center" style="margin-top: 20px;">
             ${pagingVO.pagingHTML}
        </div>
    </main>

    <div id="editArtistModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>아티스트 정보 수정</h2>
            <hr>
             <form id="editArtistForm">
                <input type="hidden" id="modalArtistNo" name="artNo">
                <div class="form-group">
                    <label for="modalArtistName">아티스트명:</label>
                    <input type="text" id="modalArtistName" name="artNm">
                </div>
                <div class="form-group">
                    <label>최근 수정일:</label>
                    <span id="displayArtistModDate"></span>
                </div>
                <div class="form-group">
                    <label for="modalArtistContent">소개글:</label>
                    <textarea id="modalArtistContent" name="artContent" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="modalArtistProfileFileSelect">프로필 이미지 파일 선택:</label>
                    <input type="file" id="modalArtistProfileFileSelect" accept="image/*">
                    <small style="display:block; margin-top:5px;">파일을 선택하면 아래 경로가 자동으로 완성됩니다.</small>
                </div>
                <div class="form-group">
                    <label for="modalArtistProfileImgPath">서버 저장 경로:</label>
                    <input type="text" id="modalArtistProfileImgPath" name="artProfileImg" readonly placeholder="파일 선택 시 C:\upload\[파일명] 형식으로 표시됩니다.">
                     <small>`C:\upload\profile\artist` 폴더에 해당 파일이 있어야 합니다.</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="action-button" id="saveArtistChangesBtn">저장</button>
                </div>
            </form>
        </div>
    </div>

<script>
$(function() {
    const $editArtistModal = $('#editArtistModal');
    const $closeButton = $editArtistModal.find('.close-button');

    const $modalArtistNoInput = $('#modalArtistNo');
    const $modalArtistName = $('#modalArtistName');
    const $displayArtistModDate = $('#displayArtistModDate');
    const $modalArtistContent = $('#modalArtistContent');

    const $modalArtistProfileFileSelect = $('#modalArtistProfileFileSelect');
    const $modalArtistProfileImgPath = $('#modalArtistProfileImgPath');

    const serverHardcodedBasePath = "C:\\upload\\profile\\artist\\";

    $('#artist-table-body').on('click', '.edit-artist-btn', function() {
        const $button = $(this);
        const artNo = $button.data('artist-no');
        const artNm = $button.data('artist-nm');
        const artModDate = $button.data('artist-mod-date'); // 포맷된 날짜 문자열
        const artContent = $button.data('artist-content');
        const currentArtProfileImgPath = $button.data('artist-profileimg');

        $modalArtistNoInput.val(artNo);
        $modalArtistName.val(artNm);
        $displayArtistModDate.text(artModDate);
        $modalArtistContent.val(artContent || '');
        $modalArtistProfileImgPath.val(currentArtProfileImgPath || '');

        $modalArtistProfileFileSelect.val('');
        $editArtistModal.css('display', 'block');
    });

    $modalArtistProfileFileSelect.on('change', function(event) {
        const files = event.target.files;
        if (files && files.length > 0) {
            const fileName = files[0].name; 
            const fullServerPath = serverHardcodedBasePath + fileName;
            $modalArtistProfileImgPath.val(fullServerPath); 
        } else {
        	// 취소 했을 때 프로필 경로 비우기
            $modalArtistProfileImgPath.val('');
        }
    });

    $closeButton.on('click', function() {
        $editArtistModal.css('display', 'none');
    });

    $(window).on('click', function(event) {
        if ($(event.target).is($editArtistModal)) {
            $editArtistModal.css('display', 'none');
        }
    });

    $('#saveArtistChangesBtn').on('click', function() {
        const artistData = {
            artNo: $modalArtistNoInput.val(),
            artNm: $modalArtistName.val(),
            artContent: $modalArtistContent.val(),
            artProfileImg: $modalArtistProfileImgPath.val()
        };

        $.ajax({
            url: '${pageContext.request.contextPath}/emp/artist/update',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(artistData),
            beforeSend : function(xhr) {
				xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}"); 
            },
            success: function(response) {
                if(response && response.success){ 
                    alert(response.message || '아티스트 정보가 성공적으로 저장되었습니다.');
                    location.reload(); 
                } else {
                     alert(response.message || '저장 중 문제가 발생했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error("저장 실패:", status, error, xhr.responseText);
                let errorMsg = '아티스트 정보 저장에 실패했습니다.';
                 try { 
                    const errResponse = JSON.parse(xhr.responseText);
                    if (errResponse && errResponse.message) {
                        errorMsg += '\n오류: ' + errResponse.message;
                    } else if (xhr.responseText) { 
                         errorMsg += '\n서버 응답: ' + xhr.responseText.substring(0,200); 
                    }
                } catch(e) {
                    if (xhr.responseText) {
                         errorMsg += '\n서버 응답: ' + xhr.responseText.substring(0,200);
                    }
                }
                alert(errorMsg);
            }
        });
    });

    // 페이지네이션 링크 클릭 시 검색 조건 유지 (getPagingHTML()이 data-page 속성을 포함한다고 가정)
    const pagingArea = $('#pagingArea');
    if(pagingArea.length > 0) {
        pagingArea.on('click', 'a[data-page]', function(event) {
            event.preventDefault();
            const page = $(this).data('page');
            
            // 현재 URL에서 검색 파라미터를 가져오거나, 검색 폼에서 직접 읽어옴
            const currentUrl = new URL(window.location.href);
            const searchType = currentUrl.searchParams.get("searchType") || $('form.artist-search-form select[name="searchType"]').val();
            const searchWord = currentUrl.searchParams.get("searchWord") || $('form.artist-search-form input[name="searchWord"]').val();

            let targetUrl = '${pageContext.request.contextPath}/emp/artist/management?page=' + page;

            if (searchType && searchWord) {
                targetUrl += '&searchType=' + encodeURIComponent(searchType);
                targetUrl += '&searchWord=' + encodeURIComponent(searchWord);
            }
            window.location.href = targetUrl;
        });
    }
});
</script>
<%-- <%@ include file="../../modules/footerPart.jsp" %> --%>
</body>
</html>