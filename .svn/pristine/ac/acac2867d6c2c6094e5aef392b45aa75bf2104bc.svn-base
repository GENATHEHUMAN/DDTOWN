<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>기안서 작성 (Bootstrap 최적화)</title>
<%@ include file="../../modules/headerPart.jsp" %>
<script src="${pageContext.request.contextPath }/resources/ckeditor/ckeditor.js"></script>
<style>
    /* 테마 색상 변수 선언 (최소한으로 유지) */
    :root {
        --theme-purple: #8a2be2; 
        --theme-purple-darker: #6c1bb1; 
        --theme-purple-lighter: #f3eaff;
    }

    /* 커스텀 포커스 스타일 (테마 색상 적용) */
    .form-control.custom-focus:focus,
    .form-select.custom-focus:focus {
        border-color: var(--theme-purple); 
        box-shadow: 0 0 0 0.2rem rgba(138, 43, 226, 0.25); 
    }
   
    /* 커스텀 버튼 스타일 (테마 색상 적용) */
    .btn-purple-theme {
        background-color: var(--theme-purple); 
        color: #fff; 
        border-color: var(--theme-purple); 
       
    }
    .btn-purple-theme:hover {
        background-color: var(--theme-purple-darker); 
        border-color: var(--theme-purple-darker);
        color: #fff;
    }

    .btn-outline-purple-theme {
        color: var(--theme-purple); 
        border-color: var(--theme-purple);
         
    }
    .btn-outline-purple-theme:hover {
        background-color: var(--theme-purple-lighter); 
        color: var(--theme-purple);
        border-color: var(--theme-purple);
    }

    /* 커스텀 테두리 색상 (테마 색상 적용) */
    .border-purple-theme { 
        border-color: var(--theme-purple) !important;
    }
</style>
</head>
<body class="bg-body-secondary">
<sec:authentication property="principal.employeeVO" var="employeeVO"/>
${employeeVO }
<form id="edmsApprovalForm" action="/edms/form" method="post">
<sec:csrfInput/>
<input type="hidden" id="edmsContent" name="edmsContent"/>
<input type="hidden" name="edmsStatCode" id="edmsStatCode"/>
<main class="container-fluid p-lg-4 p-md-3 p-2 "> 
    <div class="row">
        <div class="col-lg-8 mb-4">
            <h2 class=" text-dark mb-4">기안서 작성</h2> 
            <div class="card shadow-sm">
                <div class="card-body p-4"> 
                    <div class="mb-3">
                        <label for="formNo" class="form-label fw-semibold text-dark">문서종류</label> 
                        <select id="formNo" name="formNo" class="form-select custom-focus ">
                        	<c:forEach items="${formList }" var="formVO" varStatus="vs">
								<option value="${formVO.formNo }" <c:if test="${vs.first }">selected</c:if> >${formVO.formNm }</option>
							</c:forEach>
                        </select>
			
                    </div>

                    <div class="p-3 rounded mb-4">
                        <h5 class="text-dark border-bottom pb-2 mb-3">문서 정보</h5>
                        <div class="row mb-2 align-items-center">
                            <label for="draftDept" class="col-lg-2 col-md-3 col-form-label col-form-label-sm fw-semibold text-dark">기안 부서:</label>
                            <div class="col-lg-10 col-md-9">
                                <input type="text" class="form-control form-control-sm custom-focus" value="${employeeVO.empDepartNm }" readonly>
                            </div>
                        </div>
                        <div class="row mb-2 align-items-center">
                            <label for="empUsername" class="col-lg-2 col-md-3 col-form-label col-form-label-sm fw-semibold text-dark">기안자 이름:</label>
                            <div class="col-lg-10 col-md-9">
                                <input type="text" class="form-control form-control-sm custom-focus " id="empUsername" name="empUsername" value="${employeeVO.peoName }" readonly>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <label for="edmsReqDate" class="col-lg-2 col-md-3 col-form-label col-form-label-sm fw-semibold text-dark">기안일:</label>
                            <div class="col-lg-4 col-md-5">
                                <input type="date" id="edmsReqDate" name="edmsReqDate" class="form-control form-control-sm custom-focus ">
                            </div>
                        </div>
                    </div>
                    
					<div id="content"></div>
		
                    <div class="mb-4 d-flex align-items-center"> 
                        <label for="edmsUrgenYn" class="form-label fw-semibold text-dark me-2 mb-0">긴급도</label>
                        <select id="edmsUrgenYn" name="edmsUrgenYn" class="form-select custom-focus" style="width: auto; min-width: 100px;">
                            <option value="N">보통</option>
                            <option value="Y">긴급</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="button" class="btn btn-outline-purple-theme fw-semibold me-auto" id="approverBtn" data-bs-toggle="modal" data-bs-target="#approvalLineModal">결재선 설정</button>
                        <button type="button" class="btn btn-purple-theme fw-semibold" id="submitBtn">상신하기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
</form>
<!-- modal  -->
<div class="modal fade w-100" style="z-index:1050;"id="approvalLineModal" tabindex="-1" aria-labelledby="approvalLineModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content w-100">
			<div class="modal-header">
				<h5 class="modal-title" id="approvalLineModalLabel">결재선 설정</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="row g-3">
					<div class="col-md-3">
						<div class="card shadow-sm h-100">
							<div class="card-body d-flex flex-column">
								<h6 class="panel-heading border-bottom pb-2 mb-2">부서</h6>
								<div id="modalDepartmentList" class="list-group flex-grow-1" style="overflow-y: auto;">
								</div>
							</div>
						</div>
					</div>
				
					<div class="col-md-5">
						<div class="card shadow-sm h-100">
							<div class="card-body d-flex flex-column">
								<h6 class="panel-heading border-bottom pb-2 mb-2">직원 목록 <small id="modalSelectedDepartmentName" class="text-muted"></small></h6>
								<div id="modalEmployeeList" class="list-group mb-3 flex-grow-1" style="overflow-y: auto;">
									<p class="text-muted p-3 text-center">왼쪽에서 부서를 선택해주세요.</p>
								</div>
								<div class="d-flex justify-content-end gap-2 mt-auto pt-2 border-top">
									<button type="button" class="btn btn-sm btn-primary" id="modalAddApproversBtn">결재 추가</button>
									<button type="button" class="btn btn-sm btn-secondary" id="modalAddReferrersBtn">참조 추가</button>
								</div>
							</div>
						</div>
					</div>
				
					<div class="col-md-4">
						<div class="card shadow-sm mb-3">
							<div class="card-body">
								<h6 class="panel-heading border-bottom pb-2 mb-2">결재라인</h6>
								<div id="modalApprovalLineList" class="list-group list-group-flush" style="min-height: 150px; max-height: 180px; overflow-y: auto;">
								</div>
							</div>
						</div>
						<div class="card shadow-sm">
							<div class="card-body">
								<h6 class="panel-heading border-bottom pb-2 mb-2">참조자</h6>
								<div id="modalReferrerList" class="list-group list-group-flush" style="min-height: 150px; max-height: 180px; overflow-y: auto;">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
				<button type="button" class="btn btn-primary" id="saveApprovalLineBtn">저장</button>
			</div>
		</div>
	</div>
</div>
            
</body>
<%@ include file="../../modules/footerPart.jsp" %>
<script type="text/javascript">
	$(function(){
		let edmsApprovalForm = $("#edmsApprovalForm");
		let content = $("#content");
		let formNoEl = $("#formNo");
		let submitBtn = $("#submitBtn");
		let approverBtn = $("#approverBtn");
		let approvalLineModal = $("#approvalLineModal");
		
		// 문서 종류에 따른 양식 변경
		formNoEl.on("change",function(){
			let formNo = $(this).val() 
			formDetail(formNo);		
		})
		
		formDetail(formNoEl.val());
		
		// 상신하기 버튼 이벤트
		submitBtn.on("click",function(){
			let edmsContent = $("#edmsContent");
			let edmsStatCode = $("#edmsStatCode");
			
			// 컨텐츠에 value값들 포함시키기
			content.find('input[type="text"], input[type="date"]').each(function() {
	            $(this).attr('value', $(this).val());
	        });
	        content.find('textarea').each(function() {
	            $(this).html( $(this).val() ); // .text() 대신 .html()을 사용하여 HTML 엔티티 문제 방지 가능성
	        });
	        content.find('select').each(function() {
	            let selectedValue = $(this).val();
	            $(this).find('option').each(function() {
	                if ($(this).val() == selectedValue) { // 값으로 비교
	                    $(this).attr('selected', 'selected');
	                } else {
	                    $(this).removeAttr('selected');
	                }
	            });
	        });
	        
			edmsStatCode.val("ESC001");
			edmsContent.val(content.html())
			
		});
		
		// 결재선 관련
		// 결재선 지정 모달
		approverBtn.on("click",function(){
			approvalLineModal.modal();
			displayDepartList();
		})
		
		const modalDepartmentList = $("#modalDepartmentList");
		

		function displayDepartList(){
			$.ajax({
				url : "/api/edms/departList",
				type : "get",
				success : function(res){
					console.log(res);
					let html = ``;
					html += `<ul class="list-group">`;
					for(let data of res){
						html += `
							<li class="list-group-item list-group-item-action" data-emp-depart-code="\${data.commCodeDetNo}">\${data.description}</li>
						`
					}
					html += `</ul>`
					modalDepartmentList.html(html);
				}
			});
		}
		
		modalDepartmentList.on("click",".list-group-item",function(){
			console.log(this);
			const empDepartCode = $(this).data("empDepartCode");
			console.log(empDepartCode);
			
		})
		
		function displayEmpList(empDepartCode){
			$.ajax({
				url : "/api/edms/empList",
				type : "get",
				data : ""
			});
		}
		// 결재선 관련 끝

		
		function formDetail(formNo){
			let data = {
					formNo : formNo
			};
			$.ajax({
				url : "/api/edms/form",
				type : "post",
				beforeSend : function(xhr) {
			        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
			    },
			    contentType : "application/json; charset=utf-8",
			    data : JSON.stringify(data),
			    success : function(res){
			    	console.log(res);
			    	$("#content").html(res.formContent);
			    },
			    error : function(err){
			    	console.err(err);
			    }
			});
		}
	});
</script>
</html>