<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDTOWN 관리자 - 아티스트 계정 관리</title>
    <%@ include file="../../modules/headerPart.jsp" %>
    <style>
        /* admin_portal.css에 정의된 스타일을 최대한 활용합니다. */
        /* 아티스트명 링크 스타일 */
        .artist-name-link {
            font-weight: 500;
            color: #007bff; /* 기본 링크 색상 */
            text-decoration: none;
        }
        .artist-name-link:hover {
            text-decoration: underline;
        }
        .form-feedback-custom.text-success-custom {
	        color: #4caf50 !important; /* join.css .form-msg.success */
	        font-weight: 600;
	    }
	    .form-feedback-custom.text-danger-custom {
	        color: #e53935 !important; /* join.css .form-msg.error */
	        font-weight: 600;
	    }
    </style>
</head>
<body>
    <div class="emp-container">
        <%@ include file="../modules/header.jsp" %>

        <div class="emp-body-wrapper">
            <%@ include file="../modules/aside.jsp" %>

			<c:set var="artistVO" value="${data.artistVO }"/>
			<c:set var="memberVO" value="${artistVO.memberVO }"/>
			<c:set var="status" value="${data.status }"/>
			<c:set var="title" value="새 아티스트 등록"/>
			<c:set var="text" value="등록"/>
			<c:if test="${status eq 'U' }">
			<c:set var="title" value="아티스트 수정"/>
			<c:set var="text" value="수정"/>
			</c:if>
            <main class="emp-content">
                <section class="ea-section">
                    <div class="ea-section-header">
                        <h2>${title }</h2>
                    </div>
					
                    <form class="ea-form" id="newArtistForm" action="/admin/community/artist/register" method="post" encType="multipart/form-data">
                    	<sec:csrfInput/>
                    	<c:if test="${status eq 'U' }">
	                    	<input type="hidden" name="artNo" value="${artistVO.artNo }">
	                    	<input type="hidden" name="memUsername" value="${artistVO.memUsername }">
	                    	<input type="hidden" name="artProfileImg" value="${artistVO.artProfileImg }">
                    	</c:if>
                        <div class="form-group">
                            <label for="artistSystemId">아티스트 ID (시스템 내부용, 영문/숫자)</label>
                            <div class="input-group-button">
                                <input type="text" id="username" name="memberVO.username" value="${memberVO.username }" placeholder="예: ARTIST_A_GROUP, ARTIST_B_SOLO" <c:if test="${status eq 'U' }">readonly</c:if> required>
                                <c:if test="${status ne 'U' }">
	                                <button type="button" class="ea-btn" id="checkArtistIdBtn">중복확인</button>
                                </c:if>
                            </div>
                            <c:if test="${status ne 'U' }">
  	                          <p class="help-text">시스템에서 아티스트를 고유하게 식별하는 ID입니다. 생성 후 변경이 어렵습니다.</p>
                            </c:if>
                        </div>

                        <div class="form-group">
                            <label for="password">비밀번호</label>
                            <input type="password" id="password" name="memberVO.password" placeholder="비밀번호 입력" <c:if test="${status ne 'U' }"> required </c:if> >
                            <div id="passwordCaps" class="d-none form-text text-danger small">
		                    	Caps Lock이 켜져 있습니다.
		                    </div>
		                    <div id="passwordFeedback" class="form-feedback-custom">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">비밀번호 확인</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="비밀번호 다시 입력" <c:if test="${status ne 'U' }"> required </c:if> >
                            <div id="passwordConfirmCaps" class="d-none form-text text-danger small">
		                    	Caps Lock이 켜져 있습니다.
		                    </div>
		                    <div class="form-feedback-custom" id="passwordConfirmError"></div>
                        </div>
                        
                        <hr style="margin: 30px 0;">

                        <div class="form-group">
                            <label for="artNm">아티스트명</label>
                            <input type="text" id="artNm" name="artNm" value="${artistVO.artNm }"<c:if test="${status ne 'U' }"> required </c:if> >
                        </div>
	                        
                        <div class="form-group">
                            <label for="artistDebutDate">데뷔일</label>
                            <input type="text" id="artDebutdate" name="artDebutdate" value="${artistVO.artDebutdate }">
                        </div>
                        
                        <div class="form-group">
                            <label for="artistProfileImage">프로필 이미지</label>
                            <input type="file" id="profileImg" name="profileImg" accept="image/*" class="ea-form-control" style="width:auto; height:auto; padding: 5px;">
                            <div>
	                            <img id="profileImgPreview" src="" alt="">
                            </div>
                        </div>

						<div class="row g-2 mb-3 text-start">
                            <div class="col">
                                <label for="memLastNm" class="form-label">성 (Last Name)</label>
                                <input type="text" class="form-control" id="peoLastNm" name="memberVO.peoLastNm" value="${memberVO.peoLastNm}" placeholder="성을 입력해주세요">
                            </div>
                            <div class="col">
                                <label for="memFirstNm" class="form-label">이름 (First Name)</label>
                                <input type="text" class="form-control" id="peoFirstNm" name="memberVO.peoFirstNm" value="${memberVO.peoFirstNm}" placeholder="이름을 입력해주세요">
                            </div>
                        </div>
                        
                        <div class="mb-3 text-start">
	                        <label class="form-label">성별</label>
	                        <c:if test="${peoGender eq 'M' }">checked</c:if>
	                        <div class="gender-options">
	                            <div class="form-check form-check-inline">
	                                <input class="form-check-input" type="radio" name="memberVO.peoGender" id="genderMale" value="M" <c:if test="${memberVO.peoGender eq 'M' }">checked</c:if>>
	                                <label class="form-check-label" for="genderMale" style="width:50px; line-height: 1;">남자</label>
	                            </div>
	                            <div class="form-check form-check-inline">
	                                <input class="form-check-input" type="radio" name="memberVO.peoGender" id="genderFemale" value="F" <c:if test="${memberVO.peoGender eq 'F' }">checked</c:if>>
	                                <label class="form-check-label" for="genderFemale" style="width:50px; line-height: 1;">여자</label>
	                            </div>
	                        </div>
	                    </div>
	                    
	                    <div class="mb-3 text-start">
                            <label for="peoEmail" class="form-label">이메일 주소</label>
                            <input type="email" class="form-control" id="peoEmail" name="memberVO.peoEmail" value="${memberVO.peoEmail }" placeholder="이메일을 입력해주세요">
                        </div>
                        
	                    <div class="mb-3 text-start">
                            <label for="memBirth" class="form-label">생일</label>
                            <input type="text" class="form-control" id="memBirth" name="memberVO.memBirth" value="${memberVO.memBirth }" placeholder="이메일을 입력해주세요">
                        </div>
                        
                        <div class="mb-4 text-start"> <label for="peoPhone" class="form-label">휴대폰 번호</label>
                            <div class="input-group">
                                <input type="tel" id="peoPhone" name="memberVO.peoPhone" value="${memberVO.peoPhone }" class="form-control" placeholder="'-' 없이 숫자만 입력">
                            </div>
                            <div id="phoneFeedback" class="form-feedback-custom"></div>
                        </div>

                        <div class="form-group">
                            <label for="artContent">아티스트 소개 (선택 사항)</label>
                            <textarea id="artContent" name="artContent" placeholder="아티스트에 대한 간략한 소개를 입력하세요." class="ea-form-control">${artistVO.artContent }</textarea>
                        </div>
                        
                        
                        
                        <div class="ea-form-actions">
                            <a href="/admin/community/artist/detail?artNo=${artistVO.artNo }" class="ea-btn outline">취소</a>
                            <button type="button" class="ea-btn primary" id="registerArtistBtn">${text }</button>
                        </div>
                    </form>
                </section>
            </main>
        </div>

        <footer class="emp-footer">
            <p>&copy; 2025 DDTOWN Entertainment. All rights reserved. (관리자 전용)</p>
        </footer>
    </div>
</body>
<%@ include file="../../modules/footerPart.jsp" %>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
	// 사이드바 이벤트
	const navItemsWithSubmenu = document.querySelectorAll('.emp-sidebar .emp-nav-item.has-submenu');
	navItemsWithSubmenu.forEach(item => {
		const arrow = item.querySelector('.submenu-arrow');
		item.addEventListener('click', function(event) {
			if (this.getAttribute('href') === '#') {
			    event.preventDefault();
			}
			const parentLi = this.parentElement;
			const submenu = this.nextElementSibling;
		
			if (submenu && submenu.classList.contains('emp-submenu')) {
				const parentUl = parentLi.parentElement;
				if (parentUl) {
					Array.from(parentUl.children).forEach(siblingLi => {
						if (siblingLi !== parentLi) {
							const siblingSubmenuControl = siblingLi.querySelector('.emp-nav-item.has-submenu.open');
							if (siblingSubmenuControl) {
								const siblingSubmenu = siblingSubmenuControl.nextElementSibling;
								siblingSubmenuControl.classList.remove('open');
								if (siblingSubmenu && siblingSubmenu.classList.contains('emp-submenu')) {
								    siblingSubmenu.style.display = 'none';
								}
								const siblingArrow = siblingSubmenuControl.querySelector('.submenu-arrow');
								if (siblingArrow) siblingArrow.style.transform = 'rotate(0deg)';
							}
						}
					});
				}
			}
		
			this.classList.toggle('open');
			if (submenu && submenu.classList.contains('emp-submenu')) {
				submenu.style.display = this.classList.contains('open') ? 'block' : 'none';
				if (arrow) arrow.style.transform = this.classList.contains('open') ? 'rotate(90deg)' : 'rotate(0deg)';
			}
		});
	});
	// 사이드바 이벤트 끝
	
	let newArtistForm = $("#newArtistForm");	// 폼
	let checkArtistIdBtn = $("#checkArtistIdBtn");	// 아이디 중복체크
	let registerArtistBtn = $("#registerArtistBtn"); // 등록버튼
	let profileImgPreview = $("#profileImgPreview"); // 이미지 미리보기
	let profileImg = $("#profileImg"); // 이미지 파일
	
	// 이미지 미리보기 이벤트
	profileImg.on("change",function(){
		let files = this.files;
		let file = files[0];
		const maxSize = 2 * 1024 * 1024;
		if(!file.type.startsWith("image/")){
			sweetAlert("error", "이미지 파일만 선택가능합니다.");
			profileImg.val("");
			return false;
		}
		if(file.size > maxSize){
			sweetAlert("error", "파일사이즈는 2MB 제한입니다.");
			profileImg.val("");
			return false;
		}
		let reader = new FileReader();
		reader.onload = function(e){
			profileImgPreview.attr("src", e.target.result);
		}
		reader.readAsDataURL(file);
	});
	
	// 비밀번호 확인 이벤트
	let password = $("#password")
	let confirmPassword = $("#confirmPassword");
	let passwordCheckFlag = false;
	
	let capsLockToggle = false;
	
	$(document).on("keydown",function(e){
		if(e.keyCode == 20){
			capsLockToggle = !capsLockToggle;
		}
		
		if(capsLockToggle && password.is(":focus")){
			$("#passwordCaps").removeClass("d-none");
		}else{
			$("#passwordCaps").addClass("d-none");
		}
		
		if(capsLockToggle && confirmPassword.is(":focus")){
			$("#passwordConfirmCaps").removeClass("d-none");
		}else{
			$("#passwordConfirmCaps").addClass("d-none");
		}
	})
	
	const pwRegEx = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,16}$/;
	password.on("blur",function(){
		$("#passwordCaps").addClass("d-none");
		let pwVal = password.val();
		if(!pwRegEx.test(pwVal)){
			$("#passwordFeedback").html("8~16자 영문, 숫자, 특수문자 조합이어야 합니다.").removeClass("text-success-custom").addClass("text-danger-custom");
			passwordCheckFlag = false;
			return false;
		}else{
			passwordCheckFlag = true;
			$("#passwordFeedback").html("").removeClass("text-danger-custom text-success-custom");			
		}
		
	}).on("keyup",pwcheck).on("focus",function(){
		if(capsLockToggle){
			$("#passwordCaps").removeClass("d-none");
		}
	})
	confirmPassword.on("keyup",pwcheck).on("blur",function(){
		$("#passwordConfirmCaps").addClass("d-none");
	}).on("focus",function(){
		if(capsLockToggle){
			$("#passwordConfirmCaps").removeClass("d-none");
		}
	})
	
	// 휴대폰번호 자동 완성
	$("#peoPhone").on("focus",function(){
		let val = $(this).val();
		val = val.replaceAll("-","");
		$(this).val(val)
	})
	
	// 휴대폰번호 - 자동완성
	$("#peoPhone").on("blur",function(){
		let val = $(this).val();
		let newVal = val;
		if(val.length == 11){
			newVal = val.substring(0,3) + "-" + val.substring(3,7) + "-" + val.substring(7)
		}else if(val.length == 10){
			newVal = val.substring(0,3) + "-" + val.substring(3,6) + "-" + val.substring(6)			
		}
		$(this).val(newVal);
	})
	
	// 아이디 중복 체크
	if(checkArtistIdBtn){
		checkArtistIdBtn.on("click",function(){
			let username = $("#username").val();	// 입력한 아이디 값
			
			if(username == null || username.trim() == "") { // 아이디 입력이 비어있다면
				sweetAlert("error","아이디를 입력해주세요!");
				return false;
			}
			
			let data = {
				username : username
			};
			
			$.ajax({
				url : "/auth/idCheck",
				type : "post",
				data : JSON.stringify(data),
				contentType : "application/json; charset=utf-8",
				beforeSend : function(xhr) {
			        xhr.setRequestHeader("${_csrf.headerName}", "${_csrf.token}");
			    },
				success : function(res){
					let usernameFeedback = $("#usernameFeedback");	// error 클래스를 가지고있는 element 중 id요소에 해당하는 Element
					if(res == "NOTEXIST"){	// 아이디 사용가능
						sweetAlert("success","사용가능한 아이디입니다.");
						usernameFeedback.html("사용가능한 아이디입니다!").removeClass("text-danger-custom").addClass("text-success-custom");
						idCheckFlag = true;
					}else{					// 중복된 아이디 사용 불가능
						sweetAlert("error","이미 사용 중인 아이디 입니다.");
						usernameFeedback.html("이미 사용 중인 아이디 입니다.").removeClass("text-success-custom").addClass("text-danger-custom");
						idCheckFlag = false;
					}
				}
			});
		});
	}
	
	
	// 검증 후 전송
	registerArtistBtn.on("click",function(){
		let username = $("#username").val();
		
		if(username == null || username.trim() == ''){
			sweetAlert("error", "아이디를 입력해주세요");
			return;
		}
		
		let peoFirstNm = $("#peoFirstNm").val();	// 성 값
		let peoLastNm = $("#peoLastNm").val();	// 이름 값
		
		if(peoFirstNm == null || peoFirstNm.trim() == ""){
			sweetAlert("error","이름을 입력해주세요!");
			return false;
		}
		if(peoLastNm == null || peoLastNm.trim() == ""){
			sweetAlert("error","성을 입력해주세요!");
			return false;
		}
		
		let password = $("#password").val();
		let confirmPassword = $("#confirmPassword").val();
		
		if(confirmPassword !== password){
			sweetAlert("error", "비밀번호가 일치하지 않습니다.");
			confirmPassword.focus();
            return false;
		}
		
		let peoEmail = $("#peoEmail").val();
		let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
		if(!emailPattern.test(peoEmail)){
			sweetAlert("error","올바른 이메일 형식이 아닙니다!");
			return false;			
		}
		
		let artNm = $("#artNm").val();
		if(artNm == null || artNm.trim() == ''){
			sweetAlert("error","아티스트명을 입력해주세요!");
			return false;			
		}
		
		if(registerArtistBtn.text() == "수정"){
			newArtistForm.attr("action","/admin/community/artist/update");
		}
		
		newArtistForm.submit();
	});
	
	//비밀번호 일치 확인
	function pwcheck(){
		let pw = $("#password").val();
		let pwconfirm = $("#confirmPassword").val();
		let error = $("#passwordConfirmError");
		
		if(pwconfirm === "") {
			passwordCheckFlag = false;
			error.html("").removeClass("text-success-custom text-danger-custom");
            return;
       	}
		
		if(pw != pwconfirm){
			passwordCheckFlag = false;
			error.html("입력하신 비밀번호와 일치하지 않습니다!").removeClass("text-success-custom").addClass("text-danger-custom");
		}else{
			error.html("입력하신 비밀번호와 일치합니다").removeClass("text-danger-custom").addClass("text-success-custom");
			if(!pwRegEx.test(pw)){
				passwordCheckFlag = false; 
			}else{
				passwordCheckFlag = true;
			}
		}
	}
	
});
</script>
</html>